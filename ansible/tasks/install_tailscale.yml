---
- name: Debug - Starting Tailscale installation
  debug:
    msg: "Installing Tailscale for {{ bootstrap_hostname }}"

- name: Instalar Tailscale (Via Script Oficial)
  shell: curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/bin/tailscale

- name: Garantir que o serviço tailscaled está rodando
  systemd:
    name: tailscaled
    enabled: yes
    state: started

- name: Autenticar Tailscale
  shell: |
    tailscale up \
      --authkey="$TS_AUTHKEY" \
      --hostname={{ bootstrap_hostname }} \
      {{ tailscale_args | default('') }}
  environment:
    TS_AUTHKEY: "{{ tailscale_auth_key }}"
  register: ts_up
  no_log: true
  changed_when: "'Success' in ts_up.stdout"
  failed_when: 
    - ts_up.rc != 0
    - "'already' not in ts_up.stderr"

- name: Debug - Tailscale authentication completed
  debug:
    msg: "Tailscale connected with hostname {{ bootstrap_hostname }}"