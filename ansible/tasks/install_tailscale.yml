---
- name: Debug - Starting Tailscale installation
  debug:
    msg: "Installing Tailscale for {{ ansible_hostname }}"

- name: Instalar Tailscale (Via Script Oficial)
  shell: curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/bin/tailscale

- name: Garantir que o serviço tailscaled está rodando
  systemd:
    name: tailscaled
    enabled: yes
    state: started

# ----------------------------------------------------------------------
# Verificação de Estado (Idempotência)
# ----------------------------------------------------------------------
- name: Verificar estado atual do Tailscale
  command: tailscale status --json
  register: ts_status_check
  failed_when: false
  changed_when: false

- name: Definir fato: Tailscale está online?
  set_fact:
    is_tailscale_connected: "{{ (ts_status_check.stdout | from_json).BackendState == 'Running' }}"
  when: ts_status_check.rc == 0

# ----------------------------------------------------------------------
# Autenticação (Roda apenas se necessário)
# ----------------------------------------------------------------------
- name: Autenticar e Conectar ao Tailscale
  command: >
    tailscale up
    --authkey={{ tailscale_auth_key }}
    --hostname={{ ansible_hostname }}
    --ssh
    {{ tailscale_args | default('') }}
  register: ts_up
  no_log: true # Protege a chave de aparecer nos logs
  when: 
    - not is_tailscale_connected | default(false)
    - tailscale_auth_key is defined and tailscale_auth_key | length > 0

  # Se a chave tiver tags, --advertise-tags NÃO deve ser passado em 'tailscale_args'.
  # Se 'tailscale_args' for passado, ele será anexado ao final.

- name: Debug - Tailscale status
  debug:
    msg: "Tailscale is connected as {{ ansible_hostname }} with SSH enabled."