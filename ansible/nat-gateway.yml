---
- name: Configurar NAT Gateway & Log Server (Versão Definitiva)
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  pre_tasks:
    - name: Carregar variáveis de semente do Cloud-Init
      include_vars:
        file: /etc/ansible/host_vars/localhost.yml
      ignore_errors: true

  tasks:
    - name: Validar se a subnet privada foi definida
      assert:
        that: 
          - private_subnet is defined
          - private_subnet | length > 0
        fail_msg: "ERRO: private_subnet não encontrada no host_vars ou extra-vars!"

    # ========================================================================
    # 1. Preparação e Limpeza
    # ========================================================================
    - name: Limpar resquícios anteriores do firewall
      include_tasks: tasks/cleanup_firewall.yml

    - name: Detectar interface pública ativa (WAN)
      shell: ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1
      register: detected_public_interface
      changed_when: false

    - name: Definir fato da interface pública
      set_fact:
        public_interface: "{{ detected_public_interface.stdout }}"

    - name: Validar detecção da interface
      assert:
        that: public_interface is defined and public_interface | length > 0
        fail_msg: "CRÍTICO: Não foi possível detectar a interface pública."

    # ========================================================================
    # 2. Kernel e Módulos (Camada Baixa)
    # ========================================================================
    - name: Carregar módulos de Kernel para NAT
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - nf_nat
        - iptable_nat
        - xt_nat

    - name: Persistir módulos no boot
      copy:
        dest: /etc/modules-load.d/nat.conf
        content: |
          nf_nat
          iptable_nat
          xt_nat
        owner: root
        mode: '0644'

    - name: Habilitar IP Forwarding no Kernel (Sysctl)
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/ufw/sysctl.conf
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '0' }

    # ========================================================================
    # 3. Serviços Auxiliares (Tailscale/Logs)
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        #tailscale_args: ""

    - name: Configurar Rsyslog (UDP/TCP 514)
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?module\(load="imudp"\)', line: 'module(load="imudp")' }
        - { regexp: '^#?input\(type="imudp"',    line: 'input(type="imudp" port="514")' }
        - { regexp: '^#?module\(load="imtcp"\)', line: 'module(load="imtcp")' }
        - { regexp: '^#?input\(type="imtcp"',    line: 'input(type="imtcp" port="514")' }
      notify: Restart Rsyslog

    - name: Configurar Template de Logs Remotos
      copy:
        dest: /etc/rsyslog.d/01-central-server.conf
        content: |
          $template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
          if ($fromhost-ip != '127.0.0.1') then ?RemoteLogs
          & stop
        owner: root
        mode: '0644'
      notify: Restart Rsyslog

    - name: Instalar lnav
      apt:
        name: lnav
        state: present

    # ========================================================================
    # 4. Firewall e NAT (O Core da Solução)
    # ========================================================================
    
    - name: Forçar política global de FORWARD para ACCEPT
      lineinfile:
        path: /etc/default/ufw
        regexp: '^DEFAULT_FORWARD_POLICY='
        line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
      notify: Reload UFW

    - name: Injetar regras de NAT e Mangle no before.rules
      blockinfile:
        path: /etc/ufw/before.rules
        insertbefore: '^\*filter'
        marker: "# {mark} ANSIBLE MANAGED NAT RULES"
        block: |
          *nat
          :POSTROUTING ACCEPT [0:0]
          -A POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
          COMMIT

          *mangle
          :POSTROUTING ACCEPT [0:0]
          # Força MSS seguro para evitar problemas de MTU no tunelamento
          -A POSTROUTING -p tcp --tcp-flags SYN,RST SYN -o {{ public_interface }} -j TCPMSS --clamp-mss-to-pmtu
          COMMIT

    # Regras de INPUT (Para a própria máquina aceitar conexões)
    - name: Liberar tráfego de entrada (INPUT)
      community.general.ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.proto | default('any') }}"
        src: "{{ item.src }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: '22', proto: 'tcp', src: '100.64.0.0/10', comment: 'SSH Tailscale' }
        - { port: '22', proto: 'tcp', src: '{{ private_subnet }}', comment: 'SSH Private Subnet' }
        - { port: '514', src: '{{ private_subnet }}', comment: 'Syslog (TCP/UDP)' }
        - { port: '41641', proto: 'udp', src: 'any', comment: 'Tailscale Direct UDP' }

    - name: Liberar ROTEAMENTO da subnet privada (FORWARD)
      community.general.ufw:
        rule: allow
        route: yes
        src: "{{ private_subnet }}"
        dest: "0.0.0.0/0"
        comment: "Allow Routing from Private Subnet to Internet"

    - name: Habilitar e Recarregar UFW
      community.general.ufw:
        state: enabled
      notify: Reload UFW

    # ========================================================================
    # 5. Verificação Final (Smoke Test)
    # ========================================================================
    - name: Verificar se IP Forwarding está ativo (= 1)
      command: sysctl net.ipv4.ip_forward
      register: sysctl_check
      changed_when: false
      failed_when: "'= 1' not in sysctl_check.stdout"

    - name: Verificar existência da regra de Masquerade
      command: iptables -t nat -C POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
      register: iptables_nat_check
      changed_when: false
      failed_when: iptables_nat_check.rc != 0
      ignore_errors: yes

    - name: Exibir Status Final
      debug:
        msg: 
          - "NAT Configurado com Sucesso."
          - "Interface Pública: {{ public_interface }}"
          - "Política de Forward: ACCEPT (Forçada)"

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Reload UFW
      command: ufw reload
      changed_when: true