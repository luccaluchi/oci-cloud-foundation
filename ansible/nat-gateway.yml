---
- name: Configurar NAT Gateway & Log Server
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # Valor de fallback. O valor real é injetado pelo Cloud-init
    private_subnet: "10.0.0.0/24"

  tasks:
    - name: Debug - Playbook start
      debug:
        msg: "Starting NAT Gateway configuration on {{ ansible_hostname }}"

    # ========================================================================
    # 1. Firewall Cleanup
    # ========================================================================
    - name: Limpar firewall
      include_tasks: tasks/cleanup_firewall.yml

    # ========================================================================
    # 2. Interface Detection
    # ========================================================================
    - name: Detect active public interface
      shell: ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1
      register: detected_public_interface
      changed_when: false
      
    - name: Set public_interface fact
      set_fact:
        public_interface: "{{ detected_public_interface.stdout }}"
      when: public_interface is not defined

    - name: Assert public interface is valid
      assert:
        that: public_interface is defined and public_interface | length > 0
        fail_msg: "ERROR: Could not detect public interface for NAT."

    # ========================================================================
    # 3. Kernel & Sysctl
    # ========================================================================
    - name: Carregar módulos de kernel
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - nf_nat
        - iptable_nat

    - name: Persistir módulos no boot
      copy:
        dest: /etc/modules-load.d/nat.conf
        content: |
          nf_nat
          iptable_nat
        owner: root
        mode: '0644'

    - name: Configurar Sysctl para NAT e UFW
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/ufw/sysctl.conf
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '0' }

    # ========================================================================
    # 4. Tailscale & Logs
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        tailscale_args: "--ssh --advertise-tags=tag:nat-gateway"

    - name: Configurar recepção de logs (Rsyslog)
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?module\(load="imudp"\)', line: 'module(load="imudp")' }
        - { regexp: '^#?input\(type="imudp"',    line: 'input(type="imudp" port="514")' }
        - { regexp: '^#?module\(load="imtcp"\)', line: 'module(load="imtcp")' }
        - { regexp: '^#?input\(type="imtcp"',    line: 'input(type="imtcp" port="514")' }
      notify: Restart Rsyslog

    - name: Configurar Template de Logs Remotos
      copy:
        dest: /etc/rsyslog.d/01-central-server.conf
        content: |
          $template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
          if ($fromhost-ip != '127.0.0.1') then ?RemoteLogs
          & stop
        owner: root
        mode: '0644'
      notify: Restart Rsyslog

    - name: Instalar lnav
      apt:
        name: lnav
        state: present

    # ========================================================================
    # 5. Firewall Rules (A Correção Real)
    # ========================================================================

    # --- CORREÇÃO 1: Forçar a política padrão no arquivo de config ---
    # Isso simula o comando manual "iptables -P FORWARD ACCEPT"
    - name: Garantir política DEFAULT_FORWARD_POLICY="ACCEPT"
      lineinfile:
        path: /etc/default/ufw
        regexp: '^DEFAULT_FORWARD_POLICY='
        line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
      notify: Reload UFW

    - name: Configurar regras NAT e Mangle no UFW before.rules
      blockinfile:
        path: /etc/ufw/before.rules
        insertbefore: '^\*filter'
        marker: "# {mark} ANSIBLE MANAGED NAT RULES"
        block: |
          # NAT table rules
          *nat
          :POSTROUTING ACCEPT [0:0]
          -A POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
          COMMIT

          # Mangle table rules
          *mangle
          :POSTROUTING ACCEPT [0:0]
          -A POSTROUTING -p tcp --tcp-flags SYN,RST SYN -o {{ public_interface }} -j TCPMSS --clamp-mss-to-pmtu
          COMMIT

    # Regras de INPUT (Para acessar a máquina)
    - name: Liberar SSH e Logs (INPUT)
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        src: "{{ item.src }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: '22', proto: 'tcp', src: '100.64.0.0/10', comment: 'SSH Tailscale' }
        - { port: '22', proto: 'tcp', src: '{{ private_subnet }}', comment: 'SSH Private Subnet' }
        - { port: '514', proto: 'udp', src: '{{ private_subnet }}', comment: 'Syslog UDP' }
        - { port: '514', proto: 'tcp', src: '{{ private_subnet }}', comment: 'Syslog TCP' }
        - { port: '41641', proto: 'udp', src: 'any', comment: 'Tailscale Direct UDP' }

    # --- CORREÇÃO 2: Regra explícita de Roteamento (FORWARD) ---
    # Garante que o UFW saiba que essa rede pode atravessar a máquina
    - name: Liberar ROTEAMENTO da rede privada (FORWARD)
      community.general.ufw:
        rule: allow
        route: yes              # <--- O PULO DO GATO
        src: "{{ private_subnet }}"
        dest: "0.0.0.0/0"
        comment: "Allow Forwarding/Routing for Private Subnet"

    - name: Habilitar UFW
      community.general.ufw:
        state: enabled

    # ========================================================================
    # 6. Verification
    # ========================================================================
    - name: Verificar IP Forwarding
      command: sysctl net.ipv4.ip_forward
      register: sysctl_check
      changed_when: false
      failed_when: "'= 1' not in sysctl_check.stdout"

    - name: Verificar regra NAT POSTROUTING
      command: iptables -t nat -C POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
      register: iptables_nat_check
      changed_when: false
      failed_when: iptables_nat_check.rc != 0
      ignore_errors: yes

    - name: Exibir status final
      debug:
        msg: "NAT Gateway Configured. Forward Policy forced to ACCEPT."

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Reload UFW
      command: ufw reload
      changed_when: true