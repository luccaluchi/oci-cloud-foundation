---
- name: Configurar NAT Gateway & Log Server
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # Valor de fallback. O valor real é injetado pelo Cloud-init em /etc/ansible/host_vars/localhost.yml
    private_subnet: "10.0.0.0/24"

  tasks:
    - name: Debug - Playbook start
      debug:
        msg: "Starting NAT Gateway configuration on {{ ansible_hostname }}"

    # ========================================================================
    # 1. Interface Detection & Facts
    # ========================================================================
    - name: Detect active public interface
      shell: ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1
      register: detected_public_interface
      changed_when: false
      
    - name: Set public_interface fact
      set_fact:
        public_interface: "{{ detected_public_interface.stdout }}"
      when: public_interface is not defined

    - name: Assert public interface is valid
      assert:
        that: public_interface is defined and public_interface | length > 0
        fail_msg: "ERROR: Could not detect public interface for NAT."

    - name: Debug - Network Interface
      debug:
        msg: "Using public interface: {{ public_interface }} for NAT"

    # ========================================================================
    # 2. Kernel & Sysctl (Modern)
    # ========================================================================
    - name: Carregar módulos de kernel
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
        - nf_nat

    - name: Persistir módulos no boot (/etc/modules-load.d/nat.conf)
      copy:
        dest: /etc/modules-load.d/nat.conf
        content: |
          br_netfilter
          overlay
          nf_nat
        owner: root
        mode: '0644'

    - name: Configurar Sysctl para NAT e UFW
      # Utilizamos o módulo sysctl focando no arquivo do UFW para evitar conflitos
      # e garantir que o UFW carregue estas configs ao iniciar
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/ufw/sysctl.conf
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '0' }
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }

    # ========================================================================
    # 3. Tailscale
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        tailscale_args: "--ssh --advertise-tags=tag:nat-gateway"

    # ========================================================================
    # 4. Logs (Rsyslog)
    # ========================================================================
    - name: Configurar recepção de logs (TCP/UDP 514)
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?module\(load="imudp"\)', line: 'module(load="imudp")' }
        - { regexp: '^#?input\(type="imudp"',    line: 'input(type="imudp" port="514")' }
        - { regexp: '^#?module\(load="imtcp"\)', line: 'module(load="imtcp")' }
        - { regexp: '^#?input\(type="imtcp"',    line: 'input(type="imtcp" port="514")' }
      notify: Restart Rsyslog

    - name: Configurar Template de Logs Remotos
      copy:
        dest: /etc/rsyslog.d/01-central-server.conf
        content: |
          $template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
          if ($fromhost-ip != '127.0.0.1') then ?RemoteLogs
          & stop
        owner: root
        mode: '0644'
      notify: Restart Rsyslog

    - name: Instalar lnav
      apt:
        name: lnav
        state: present

    # ========================================================================
    # 5. Firewall: Limpar Tudo e Recriar (Abordagem Simples)
    # ========================================================================
    - name: Desabilitar UFW temporariamente
      community.general.ufw:
        state: disabled
      ignore_errors: true

    - name: Limpar todas as regras iptables (filter)
      command: iptables -F
      ignore_errors: true

    - name: Limpar todas as regras iptables (nat)
      command: iptables -t nat -F
      ignore_errors: true

    - name: Limpar todas as regras iptables (mangle)
      command: iptables -t mangle -F
      ignore_errors: true

    - name: Limpar todas as regras iptables (raw)
      command: iptables -t raw -F
      ignore_errors: true

    - name: Deletar chains customizadas (filter)
      command: iptables -X
      ignore_errors: true

    - name: Deletar chains customizadas (nat)
      command: iptables -t nat -X
      ignore_errors: true

    - name: Configurar políticas padrão
      shell: |
        iptables -P INPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -P OUTPUT ACCEPT
      ignore_errors: true

    - name: Remover netfilter-persistent (conflita com UFW)
      apt:
        name: 
          - netfilter-persistent
          - iptables-persistent
        state: absent
        purge: yes
      ignore_errors: true

    - name: Remover regras salvas do netfilter-persistent
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/iptables/rules.v4
        - /etc/iptables/rules.v6
      ignore_errors: true

    - name: Reset completo do UFW
      command: ufw --force reset
      changed_when: true

    - name: Configurar UFW defaults
      lineinfile:
        path: /etc/default/ufw
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^DEFAULT_INPUT_POLICY=', line: 'DEFAULT_INPUT_POLICY="DROP"' }
        - { regexp: '^DEFAULT_OUTPUT_POLICY=', line: 'DEFAULT_OUTPUT_POLICY="ACCEPT"' }
        - { regexp: '^DEFAULT_FORWARD_POLICY=', line: 'DEFAULT_FORWARD_POLICY="ACCEPT"' }
        - { regexp: '^IPV6=', line: 'IPV6=no' }

    - name: Configurar regras NAT no UFW before.rules
      blockinfile:
        path: /etc/ufw/before.rules
        insertbefore: '^\*filter'
        marker: "# {mark} ANSIBLE MANAGED NAT RULES"
        block: |
          # NAT table rules
          *nat
          :POSTROUTING ACCEPT [0:0]
          
          # Forward traffic from private subnet through public interface
          -A POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
          
          COMMIT
      
    - name: Configurar regras adicionais no before.rules (filter)
      blockinfile:
        path: /etc/ufw/before.rules
        insertafter: '^\*filter'
        marker: "# {mark} ANSIBLE MANAGED FILTER RULES"
        block: |
          # Allow all on loopback
          -A INPUT -i lo -j ACCEPT
          -A OUTPUT -o lo -j ACCEPT
          
          # Allow established/related connections
          -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
          -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
          
          # Allow ICMP (ping, etc)
          -A INPUT -p icmp -j ACCEPT
          
          # SSH apenas de redes confiáveis (Tailscale e Private Subnet)
          -A INPUT -p tcp -s 100.64.0.0/10 --dport 22 -j ACCEPT
          -A INPUT -p tcp -s {{ private_subnet }} --dport 22 -j ACCEPT
          
          # Allow Tailscale
          -A INPUT -p udp --dport 41641 -j ACCEPT
          -A INPUT -s 100.64.0.0/10 -j ACCEPT
          
          # Allow from private subnet
          -A INPUT -s {{ private_subnet }} -j ACCEPT
          
          # Allow forwarding from private subnet
          -A FORWARD -s {{ private_subnet }} -j ACCEPT
          
          # Allow rsyslog from private subnet
          -A INPUT -p tcp -s {{ private_subnet }} --dport 514 -j ACCEPT
          -A INPUT -p udp -s {{ private_subnet }} --dport 514 -j ACCEPT

    - name: Habilitar UFW
      community.general.ufw:
        state: enabled

    - name: Garantir que UFW inicia no boot
      systemd:
        name: ufw
        enabled: yes

    # ========================================================================
    # 6. Verification & Cleanup
    # ========================================================================
    - name: Verificar IP Forwarding
      command: sysctl net.ipv4.ip_forward
      register: sysctl_check
      changed_when: false
      failed_when: "'= 1' not in sysctl_check.stdout"

    - name: Verificar regra NAT POSTROUTING
      command: iptables -t nat -C POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
      register: iptables_nat_check
      changed_when: false
      failed_when: iptables_nat_check.rc != 0
      ignore_errors: yes

    - name: Verificar status UFW
      command: ufw status verbose
      register: ufw_status_check
      changed_when: false

    - name: Exibir configuração final do firewall
      debug:
        msg:
          - "========================================="
          - "NAT Gateway Firewall Configuration"
          - "========================================="
          - "IP Forwarding: {{ 'ENABLED' if '= 1' in sysctl_check.stdout else 'DISABLED' }}"
          - "NAT Rule: {{ 'CONFIGURED' if iptables_nat_check.rc == 0 else 'MISSING' }}"
          - "UFW Status: {{ 'ACTIVE' if 'Status: active' in ufw_status_check.stdout else 'INACTIVE' }}"
          - "Public Interface: {{ public_interface }}"
          - "Private Subnet: {{ private_subnet }}"
          - "========================================="

    - name: Salvar configuração de iptables via UFW
      command: ufw reload
      changed_when: false

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Reload UFW
      command: ufw reload
      changed_when: true