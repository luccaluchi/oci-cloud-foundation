---
- name: Configurar NAT Gateway & Log Server
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # Valor de fallback. O valor real é injetado pelo Cloud-init em /etc/ansible/host_vars/localhost.yml
    private_subnet: "10.0.0.0/24"

  tasks:
    - name: Debug - Playbook start
      debug:
        msg: "Starting NAT Gateway configuration on {{ ansible_hostname }}"

    # ========================================================================
    # 1. Firewall Cleanup (Prioridade Máxima)
    # ========================================================================
    - name: Limpar firewall e configurar UFW como única fonte de verdade
      include_tasks: tasks/cleanup_firewall.yml
      vars:
        ufw_forward_policy: ACCEPT  # Necessário para NAT/routing

    # ========================================================================
    # 2. Interface Detection & Facts
    # ========================================================================
    - name: Detect active public interface
      shell: ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1
      register: detected_public_interface
      changed_when: false
      
    - name: Set public_interface fact
      set_fact:
        public_interface: "{{ detected_public_interface.stdout }}"
      when: public_interface is not defined

    - name: Assert public interface is valid
      assert:
        that: public_interface is defined and public_interface | length > 0
        fail_msg: "ERROR: Could not detect public interface for NAT."

    - name: Debug - Network Interface
      debug:
        msg: "Using public interface: {{ public_interface }} for NAT"

    # ========================================================================
    # 3. Kernel & Sysctl (Modern)
    # ========================================================================
    - name: Carregar módulos de kernel
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - nf_nat

    - name: Persistir módulos no boot (/etc/modules-load.d/nat.conf)
      copy:
        dest: /etc/modules-load.d/nat.conf
        content: |
          nf_nat
        owner: root
        mode: '0644'

    - name: Configurar Sysctl para NAT e UFW
      # Utilizamos o módulo sysctl focando no arquivo do UFW para evitar conflitos
      # e garantir que o UFW carregue estas configs ao iniciar
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/ufw/sysctl.conf
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '0' }

    # ========================================================================
    # 3. Tailscale
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        tailscale_args: "--ssh --advertise-tags=tag:nat-gateway"

    # ========================================================================
    # 4. Logs (Rsyslog)
    # ========================================================================
    - name: Configurar recepção de logs (TCP/UDP 514)
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?module\(load="imudp"\)', line: 'module(load="imudp")' }
        - { regexp: '^#?input\(type="imudp"',    line: 'input(type="imudp" port="514")' }
        - { regexp: '^#?module\(load="imtcp"\)', line: 'module(load="imtcp")' }
        - { regexp: '^#?input\(type="imtcp"',    line: 'input(type="imtcp" port="514")' }
      notify: Restart Rsyslog

    - name: Configurar Template de Logs Remotos
      copy:
        dest: /etc/rsyslog.d/01-central-server.conf
        content: |
          $template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
          if ($fromhost-ip != '127.0.0.1') then ?RemoteLogs
          & stop
        owner: root
        mode: '0644'
      notify: Restart Rsyslog

    - name: Instalar lnav
      apt:
        name: lnav
        state: present

    # ========================================================================
    # 5. Firewall: Limpar Tudo e Recriar (Abordagem Simples)
    # ========================================================================
    - name: Limpar firewall e configurar UFW como única fonte de verdade
      include_tasks: tasks/cleanup_firewall.yml
    # ========================================================================
    # 6. Firewall Rules
    # ========================================================================

    - name: Configurar regras NAT no UFW before.rules
      blockinfile:
        path: /etc/ufw/before.rules
        insertbefore: '^\*filter'
        marker: "# {mark} ANSIBLE MANAGED NAT RULES"
        block: |
          # NAT table rules
          *nat
          :POSTROUTING ACCEPT [0:0]
          
          # Forward traffic from private subnet through public interface
          -A POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
          
          COMMIT

    - name: Liberar SSH (VPN e Subnet Privada)
      community.general.ufw:
        rule: allow
        port: 22
        proto: tcp
        src: "{{ item }}"
        comment: "SSH {{ item }}"
      loop:
        - '100.64.0.0/10'
        - '{{ private_subnet }}'

    - name: Liberar Tailscale UDP
      community.general.ufw:
        rule: allow
        port: 41641
        proto: udp
        comment: "Tailscale Direct UDP"

    - name: Liberar rede Tailscale
      community.general.ufw:
        rule: allow
        src: '100.64.0.0/10'
        comment: "Allow Tailscale Network"

    - name: Liberar rede privada
      community.general.ufw:
        rule: allow
        src: "{{ private_subnet }}"
        comment: "Allow Private Subnet"

    - name: Liberar Rsyslog da rede privada
      community.general.ufw:
        rule: allow
        port: 514
        proto: "{{ item }}"
        src: "{{ private_subnet }}"
        comment: "Rsyslog"
      loop:
        - tcp
        - udp

    - name: Habilitar UFW
      community.general.ufw:
        state: enabled

    - name: Garantir que UFW inicia no boot
      systemd:
        name: ufw
        enabled: yes

    # ========================================================================
    # 6. Verification & Cleanup
    # ========================================================================
    - name: Verificar IP Forwarding
      command: sysctl net.ipv4.ip_forward
      register: sysctl_check
      changed_when: false
      failed_when: "'= 1' not in sysctl_check.stdout"

    - name: Verificar regra NAT POSTROUTING
      command: iptables -t nat -C POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
      register: iptables_nat_check
      changed_when: false
      failed_when: iptables_nat_check.rc != 0
      ignore_errors: yes

    - name: Verificar status UFW
      command: ufw status verbose
      register: ufw_status_check
      changed_when: false

    - name: Exibir configuração final do firewall
      debug:
        msg:
          - "========================================="
          - "NAT Gateway Firewall Configuration"
          - "========================================="
          - "IP Forwarding: {{ 'ENABLED' if '= 1' in sysctl_check.stdout else 'DISABLED' }}"
          - "NAT Rule: {{ 'CONFIGURED' if iptables_nat_check.rc == 0 else 'MISSING' }}"
          - "UFW Status: {{ 'ACTIVE' if 'Status: active' in ufw_status_check.stdout else 'INACTIVE' }}"
          - "Public Interface: {{ public_interface }}"
          - "Private Subnet: {{ private_subnet }}"
          - "========================================="

    - name: Salvar configuração de iptables via UFW
      command: ufw reload
      changed_when: false

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Reload UFW
      command: ufw reload
      changed_when: true