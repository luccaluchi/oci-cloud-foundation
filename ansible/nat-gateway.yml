---
- name: Configurar NAT Gateway & Log Server
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # Valor de fallback. O valor real é injetado pelo Cloud-init em /etc/ansible/host_vars/localhost.yml
    private_subnet: "10.0.0.0/24"

  tasks:
    - name: Debug - Playbook start
      debug:
        msg: "Starting NAT Gateway configuration on {{ ansible_hostname }}"

    # ========================================================================
    # 1. Interface Detection & Facts
    # ========================================================================
    - name: Detect active public interface
      shell: ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1
      register: detected_public_interface
      changed_when: false
      
    - name: Set public_interface fact
      set_fact:
        public_interface: "{{ detected_public_interface.stdout }}"
      when: public_interface is not defined

    - name: Assert public interface is valid
      assert:
        that: public_interface is defined and public_interface | length > 0
        fail_msg: "ERROR: Could not detect public interface for NAT."

    - name: Debug - Network Interface
      debug:
        msg: "Using public interface: {{ public_interface }} for NAT"

    # ========================================================================
    # 2. Kernel & Sysctl (Modern)
    # ========================================================================
    - name: Carregar módulos de kernel
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
        - nf_nat

    - name: Persistir módulos no boot (/etc/modules-load.d/nat.conf)
      copy:
        dest: /etc/modules-load.d/nat.conf
        content: |
          br_netfilter
          overlay
          nf_nat
        owner: root
        mode: '0644'

    - name: Configurar Sysctl para NAT e UFW
      # Utilizamos o módulo sysctl focando no arquivo do UFW para evitar conflitos
      # e garantir que o UFW carregue estas configs ao iniciar
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/ufw/sysctl.conf
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '0' }
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }

    # ========================================================================
    # 3. Tailscale
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        tailscale_args: "--ssh --advertise-tags=tag:nat-gateway"

    # ========================================================================
    # 4. Logs (Rsyslog)
    # ========================================================================
    - name: Configurar recepção de logs (TCP/UDP 514)
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?module\(load="imudp"\)', line: 'module(load="imudp")' }
        - { regexp: '^#?input\(type="imudp"',    line: 'input(type="imudp" port="514")' }
        - { regexp: '^#?module\(load="imtcp"\)', line: 'module(load="imtcp")' }
        - { regexp: '^#?input\(type="imtcp"',    line: 'input(type="imtcp" port="514")' }
      notify: Restart Rsyslog

    - name: Configurar Template de Logs Remotos
      copy:
        dest: /etc/rsyslog.d/01-central-server.conf
        content: |
          $template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
          if ($fromhost-ip != '127.0.0.1') then ?RemoteLogs
          & stop
        owner: root
        mode: '0644'
      notify: Restart Rsyslog

    - name: Instalar lnav
      apt:
        name: lnav
        state: present

    # ========================================================================
    # 5. UFW & NAT Rules (Optimized)
    # ========================================================================
    - name: Definir política de Forwarding no UFW
      lineinfile:
        path: /etc/default/ufw
        regexp: '^DEFAULT_FORWARD_POLICY='
        line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
      notify: Reload UFW

    - name: Inserir regras de NAT (Masquerade)
      blockinfile:
        path: /etc/ufw/before.rules
        insertbefore: '^\*filter'
        marker: "# {mark} ANSIBLE MANAGED NAT RULES"
        block: |
          *nat
          :POSTROUTING ACCEPT [0:0]
          -A POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
          COMMIT
      notify: Reload UFW

    - name: Aplicar regras mínimas de Firewall
      community.general.ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.proto | default('any') }}"
        src: "{{ item.src | default('any') }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: 22, proto: 'tcp', comment: 'SSH' }
        - { port: 41641, proto: 'udp', comment: 'Tailscale Direct UDP' }
        - { port: 514, src: "{{ private_subnet }}", comment: 'Syslog UDP (Private)' }
        - { port: 514, proto: 'tcp', src: "{{ private_subnet }}", comment: 'Syslog TCP (Private)' }
        - { src: '100.64.0.0/10', comment: 'Tailscale VPN' }
        - { src: "{{ private_subnet }}", comment: 'Private Subnet' }

    - name: Enable UFW (Ensure active)
      community.general.ufw:
        state: enabled

    # ========================================================================
    # 6. Verification
    # ========================================================================
    - name: Verify IP Forwarding status
      command: sysctl net.ipv4.ip_forward
      register: sysctl_check
      changed_when: false
      failed_when: "'= 1' not in sysctl_check.stdout"

    - name: Verify NAT POSTROUTING rule
      # Verifica se a regra existe. Usa '-C' (Check). Retorna 0 se existe.
      command: iptables -t nat -C POSTROUTING -s {{ private_subnet }} -o {{ public_interface }} -j MASQUERADE
      register: iptables_check
      changed_when: false
      failed_when: iptables_check.rc != 0
      ignore_errors: yes # Warn only

    - name: Check UFW status
      command: ufw status verbose
      register: ufw_check
      changed_when: false

    - name: Debug - Verification Results
      debug:
        msg:
          - "Forwarding: {{ sysctl_check.stdout }}"
          - "NAT Rule Exists: {{ iptables_check.rc == 0 }}"
          - "UFW Status: {{ ufw_check.stdout_lines[0] }}"

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Reload UFW
      community.general.ufw:
        state: reloaded