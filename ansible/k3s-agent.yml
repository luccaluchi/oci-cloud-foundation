---
- name: Configurar K3s Agent (Worker Node)
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  pre_tasks:
      - name: Carregar variáveis de semente do Cloud-Init
        include_vars:
          file: /etc/ansible/host_vars/localhost.yml
        ignore_errors: true
      
  tasks:
    - name: Debug - Playbook start
      debug:
        msg: "Starting K3s Agent configuration on {{ ansible_hostname }}"

    # ========================================================================
    # 1. Preparação do Sistema (Firewall e Pacotes)
    # ========================================================================
    - name: Limpar firewall e configurar UFW como única fonte de verdade
      include_tasks: tasks/cleanup_firewall.yml
      vars:
        ufw_forward_policy: ACCEPT
        ufw_ipv6_enabled: no

    - name: Instalar dependências do WireGuard
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: yes

    # ========================================================================
    # 2. Configuração de Kernel e Sistema
    # ========================================================================
    - name: Carregar módulos de kernel (Runtime)
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
        - wireguard

    - name: Persistir módulos no boot
      copy:
        dest: /etc/modules-load.d/k3s.conf
        content: |
          br_netfilter
          overlay
          wireguard
        owner: root
        mode: '0644'

    - name: Configurar sysctls para Kubernetes
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv6.conf.all.disable_ipv6', value: '1' }
        - { name: 'net.ipv6.conf.default.disable_ipv6', value: '1' }
        - { name: 'net.ipv6.conf.lo.disable_ipv6', value: '1' }

    # ========================================================================
    # 3. Configuração de Rede e Logs
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        #tailscale_args: ""

    - name: Garantir configuração do Rsyslog Client
      include_tasks: tasks/setup_rsyslog_client.yml

    - name: Obter IP Privado (OCI VCN)
      set_fact:
        private_ip: "{{ ansible_default_ipv4.address }}"

    # ========================================================================
    # 4. Firewall Rules (UFW)
    # ========================================================================
    
    - name: Liberar portas essenciais do K3s Agent
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        src: '10.0.0.0/16'
        comment: "{{ item.comment }}"
      loop:
        - { port: 10250, proto: 'tcp', comment: 'Kubelet (VCN)' }
        - { port: 8472, proto: 'udp', comment: 'Flannel VXLAN' }
        - { port: 51820, proto: 'udp', comment: 'Flannel WireGuard' }
        - { port: 51821, proto: 'udp', comment: 'Flannel WireGuard IPv6' }

    - name: Liberar NodePorts da VCN
      community.general.ufw:
        rule: allow
        port: 30000:32767
        proto: tcp
        src: '10.0.0.0/16'
        comment: 'NodePorts (VCN)'

    - name: Liberar Tailscale UDP
      community.general.ufw:
        rule: allow
        port: 41641
        proto: udp
        comment: 'Tailscale UDP'

    - name: Liberar toda rede Tailscale
      community.general.ufw:
        rule: allow
        src: '100.64.0.0/10'
        comment: 'Tailscale VPN'

    - name: Liberar Pod CIDR (10.42.0.0/16)
      community.general.ufw:
        rule: allow
        src: '10.42.0.0/16'
        comment: 'Pod CIDR'

    - name: SSH apenas de Tailscale e subnet privada
      community.general.ufw:
        rule: allow
        port: 22
        proto: tcp
        src: "{{ item }}"
        comment: "SSH {{ item }}"
      loop:
        - '100.64.0.0/10'
        - '10.0.0.0/16'

    - name: Habilitar UFW
      community.general.ufw:
        state: enabled

    - name: Garantir UFW no boot (Camada extra de segurança)
      systemd:
        name: ufw
        enabled: yes

    # ========================================================================
    # 5. Instalação do K3s Agent
    # ========================================================================
    
    - name: Aguardar K3s Server estar acessível
      wait_for:
        host: "{{ k3s_server_ip }}"
        port: 6443
        delay: 5
        timeout: 600
        state: started

    - name: Criar diretório de configuração
      file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: Criar arquivo config.yaml (Agent)
      copy:
        dest: /etc/rancher/k3s/config.yaml
        content: |
          server: "https://{{ k3s_server_ip }}:6443"
          token: "{{ k3s_token }}"
          node-ip: "{{ private_ip }}"
          node-label:
            - topology.kubernetes.io/region=oci-br
            - node.kubernetes.io/instance-type=ampere
            - workload=apps
        owner: root
        mode: '0644'
      notify: Restart K3s Agent

    - name: Instalar K3s Agent
      shell: |
        curl -sfL https://get.k3s.io | sh -s - agent
      args:
        creates: /usr/local/bin/k3s-agent

    - name: Verificar se serviço está rodando
      systemd:
        name: k3s-agent
        state: started
        enabled: yes

    - name: Debug - Playbook completed
      debug:
        msg: "K3s Agent configuration completed successfully on {{ ansible_hostname }}"

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Restart K3s Agent
      service:
        name: k3s-agent
        state: restarted

    - name: Reload UFW
      command: ufw reload
      changed_when: true