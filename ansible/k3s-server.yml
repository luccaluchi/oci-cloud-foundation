---
- name: Configurar K3s Server (Control Plane) - WireGuard Edition
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    vcn_cidr: "10.0.0.0/16"

  tasks:
    - name: Debug - Playbook start
      debug:
        msg: "Starting K3s Server (WireGuard) configuration on {{ ansible_hostname }}"

    # ========================================================================
    # 1. Preparação do Sistema (Firewall e Pacotes)
    # ========================================================================
    - name: Limpar firewall e configurar UFW
      include_tasks: tasks/cleanup_firewall.yml
      vars:
        ufw_forward_policy: ACCEPT
        ufw_ipv6_enabled: no

    - name: Instalar dependências do WireGuard
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: yes

    # ========================================================================
    # 2. Kernel & System
    # ========================================================================
    - name: Carregar módulos de kernel (Essencial para WireGuard Native)
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
        - wireguard  # Obrigatório estar carregado

    - name: Persistir módulos no boot
      copy:
        dest: /etc/modules-load.d/k3s.conf
        content: |
          br_netfilter
          overlay
          wireguard
        owner: root
        mode: '0644'

    - name: Configurar sysctls para Kubernetes
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_set: yes
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv6.conf.all.disable_ipv6', value: '1' }

    # ========================================================================
    # 3. Rede e Logs
    # ========================================================================
    - name: Configurar Tailscale
      include_tasks: tasks/install_tailscale.yml
      vars:
        tailscale_args: "--ssh --advertise-tags=tag:k3s-server"

    - name: Garantir configuração do Rsyslog Client
      include_tasks: tasks/setup_rsyslog_client.yml

    - name: Obter IP do Tailscale
      command: tailscale ip -4
      register: ts_ip
      failed_when: false
      changed_when: false

    - name: Obter IP Privado
      set_fact:
        private_ip: "{{ ansible_default_ipv4.address }}"

    # ========================================================================
    # 4. Firewall Rules (Portas do WireGuard)
    # ========================================================================
    - name: Liberar portas essenciais do K3s e WireGuard
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        src: "{{ item.src | default('any') }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: 6443, proto: 'tcp', src: '{{ vcn_cidr }}', comment: 'K3s API (VCN)' }
        - { port: 6443, proto: 'tcp', src: '100.64.0.0/10', comment: 'K3s API (Tailscale)' }
        - { port: 10250, proto: 'tcp', src: '{{ vcn_cidr }}', comment: 'Kubelet' }
        - { port: '2379:2380', proto: 'tcp', src: '{{ vcn_cidr }}', comment: 'ETCD' }
        # Portas WireGuard (Essenciais para flannel-backend: wireguard-native)
        - { port: 51820, proto: 'udp', src: '{{ vcn_cidr }}', comment: 'Flannel WireGuard' }
        - { port: 51821, proto: 'udp', src: '{{ vcn_cidr }}', comment: 'Flannel WireGuard IPv6' }
        - { port: 41641, proto: 'udp', src: 'any', comment: 'Tailscale UDP' }

    - name: Liberar NodePorts, Pods e SSH
      community.general.ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.proto | default('any') }}"
        src: "{{ item.src }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: '30000:32767', proto: 'tcp', src: '{{ vcn_cidr }}', comment: 'NodePorts' }
        - { src: '100.64.0.0/10', comment: 'Tailscale VPN' }
        - { src: '10.42.0.0/16', comment: 'Pod CIDR' }
        - { port: 22, proto: 'tcp', src: '100.64.0.0/10', comment: 'SSH Tailscale' }
        - { port: 22, proto: 'tcp', src: '{{ vcn_cidr }}', comment: 'SSH VCN' }

    - name: Habilitar UFW
      community.general.ufw:
        state: enabled

    # ========================================================================
    # 5. Configuração e Instalação K3s (WireGuard Native)
    # ========================================================================
    - name: Criar diretório /etc/rancher/k3s
      file:
        path: /etc/rancher/k3s
        state: directory
        owner: root
        mode: '0755'

    - name: Criar /etc/rancher/k3s/config.yaml
      copy:
        dest: /etc/rancher/k3s/config.yaml
        content: |
          node-ip: "{{ private_ip }}"
          token: "{{ k3s_token }}"
          write-kubeconfig-mode: "0644"

          tls-san:
            - "{{ ansible_hostname }}"
            - "{{ ts_ip.stdout | default('') }}"

          disable:
            - traefik
            - servicelb

          flannel-backend: wireguard-native

          node-label:
            - topology.kubernetes.io/region=oci-br
            - node.kubernetes.io/instance-type=ampere
            - tipo=infra
        owner: root
        mode: '0644'
      notify: Restart K3s

    - name: Instalar K3s Server
      shell: curl -sfL https://get.k3s.io | sh -s - server
      environment:
        K3S_TOKEN: "{{ k3s_token }}"
      args:
        creates: /usr/local/bin/k3s
      register: install_k3s
      failed_when: install_k3s.rc != 0 and install_k3s.rc != 1

    # ========================================================================
    # 6. Pós-Instalação e Ajustes Finos
    # ========================================================================
    - name: Configurar acesso para usuario ubuntu
      block:
        - name: Criar pasta .kube
          file:
            path: /home/ubuntu/.kube
            state: directory
            owner: ubuntu
            group: ubuntu
            mode: '0755'
        
        - name: Copiar kubeconfig
          copy:
            src: /etc/rancher/k3s/k3s.yaml
            dest: /home/ubuntu/.kube/config
            remote_src: yes
            owner: ubuntu
            group: ubuntu
            mode: '0600'
          ignore_errors: true

    - name: Aguardar K3s ficar Ready
      command: kubectl get node "{{ ansible_hostname }}" -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: k3s_ready
      until: k3s_ready.stdout == "True"
      retries: 60
      delay: 10
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  handlers:
    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Restart K3s
      service:
        name: k3s
        state: restarted

    - name: Reload UFW
      command: ufw reload
      changed_when: true